**Руководство программиста**

**Система управления индивидуальными отчётами ТулГУ**

Фесунов А.А.  Володин И.А. Шуверов А.А.

Специально для Тульского Государственного Университета



**1 Стек**

Backend:

- .NET 8.0

- ASP.NET Core Web API

- Entity Framework Core для работы с БД

- PostgreSQL в качестве БД

- NPOI для работы с Excel файлами

- JWT Bearer для аутентификации

- Swagger/OpenAPI для документации API

Frontend:

- Angular

- Angular Material

- TypeScript для типизации

- SCSS для стилей

- ESLint для статического анализа кода

- RxJS для реактивного программирования

DevOps и инфраструктура:

- Docker для контейнеризации

- Docker Compose для оркестрации

- Linux как целевая ОС для контейнеров

- GitHub для версионирования

**2 Запуск проекта**

Все сервисы запускаются через Docker Compose. Чтобы запустить сборку
проекта, перейдите hb-docker (относительно корня репозитория) и введите:

docker compose up -d

Production контейнер не работает через hot-reload, поэтому для
разработки, дебага и любого другого изменения проекта удобнее всего
запустить его локально на своём компьютере:

Сначала необходимо запустить фронтенд:

1.  Переходим в hb-front,

2.  В файлах environment.ts и environment.development.ts сменить ip на
    localhost:63656

3.  Пишем в консоли  
    npm run start

4.  Открыть сайт в браузере по ссылке <http://localhost:4200/auth/login>


Далее необходимо запустить бекенд:

1.  Переименовать с appsettings.Example.json в appsettings.json

2.  Указать \"applicationUrl\":
    [https://localhost:63656;http://localhost:63655](https://localhost:63656;http://localhost:63655)

3.  Запустить проект Tsu.IndividualPlan.WebApi

4.  Перейти по ссылке https://localhost:63656/swagger/index.html

**3 Структура проекта**

hb-back содержит серверную часть приложения, где реализована вся
бизнес-логика, работа с базой данных и API эндпоинты. Здесь находятся
четыре ключевых проекта - Domain с бизнес-моделями, Data для работы с
базой данных, Transfer для передачи данных и WebApi для обработки
HTTP-запросов.

hb-docker содержит все необходимые конфигурации для контейнеризации. В
ней находятся Dockerfile для бэкенда и фронтенда, docker-compose файл
для оркестрации контейнеров, а также различные конфигурационные файлы
для настройки окружения разработки и продакшена. Это обеспечивает
единообразное окружение для разработки и упрощает процесс развертывания
приложения.

hb-front содержит клиентскую часть приложения, разработанную на Angular.
В ней находятся все компоненты пользовательского интерфейса, сервисы для
взаимодействия с API, модули для различных функциональных блоков системы
и стили. Эта часть отвечает за то, что видит пользователь и как он
взаимодействует с системой.

hb-hooks содержит Git-хуки для автоматизации процесса разработки. В ней
находятся скрипты, которые запускаются автоматически при определенных
Git-операциях: проверка форматирования кода перед коммитом, запуск
тестов перед отправкой изменений в репозиторий и обновление зависимостей
после слияния веток. Это помогает поддерживать качество кода и
единообразие его стиля в проекте.

**4 Backend Архитектура**

В бэкенде проекта используется паттерн MVC (Model-View-Controller),
реализованный с помощью ASP.NET Core. Модели (Models) представлены в
проекте Tsu.IndividualPlan.Domain, где определены основные
бизнес-сущности, такие как отчеты, планы, ставки и пользователи.
Контроллеры (Controllers) находятся в проекте Tsu.IndividualPlan.WebApi
и отвечают за обработку HTTP-запросов, управление бизнес-логикой и
возврат данных. Поскольку используется Web API, представления (Views)
как таковые отсутствуют - вместо них API возвращает данные в формате
JSON, которые затем обрабатываются и отображаются фронтендом на Angular.

В бэкенде проекта применяется подход Domain-Driven Design (DDD), что
отражается в его структуре и организации кода. Проект
Tsu.IndividualPlan.Domain является центральным и содержит все
бизнес-правила и логику предметной области. Слои приложения четко
разделены: Domain содержит бизнес-логику и не зависит от внешних слоев,
Data отвечает за персистентность и реализует интерфейсы репозиториев из
доменного слоя, Transfer обеспечивает преобразование между доменными
объектами и DTO, а WebApi предоставляет точки входа в приложение. Такое
разделение соответствует принципам DDD о изоляции домена от
инфраструктурных деталей.

**4.1 Работа с отчётами и бизнес-логика (Tsu.IndividualPlan.Domain)**

В проекте Tsu.IndividualPlan.Domain реализована ключевая бизнес-логика
для работы с документами и отчетами. Система начинает работу с загрузки
первой части плана, полученной от деканата - этот документ содержит
базовую учебную нагрузку преподавателя и служит основой для формирования
полного индивидуального плана. Загруженный документ проходит валидацию
на соответствие формату и корректность данных, после чего данные
извлекаются и сохраняются в базу данных. Также, именно в этом проекте
хранится логика формирования и загрузки второй части отчёта.

2.  **База данных (Tsu.IndividualPlan.Data)**

**4.2.1 Схема БД и связи между таблицами**

![photo_2024-06-12_19-09-30](https://github.com/user-attachments/assets/d735fd39-498a-4a30-8c39-c3b1663e228b)

1\. Users - Пользователи системы

2\. States - Ставки преподавателей (созданные админом)

3\. Departments - Кафедры

4\. Institutes - Институты

5\. Reports - Индивидуальные планы

6\. Lessons - Учебные дисциплины

7\. LessonTypes - Типы занятий (например, \"Информатика\", \"Подготовка
публикаций и (или) заявки на патенты\")

8\. Events - События в плане, связь StateUser с EventType

9\. EventTypes - Типы событий (например, "Подготовка экспоната на
выставку")

10\. Comments - Комментарии к событиям

11\. Records - Записи о выполненной работе (формируются из первой части)

12\. Jobs -- Должности (например, \"Доцент\", \"Профессор\")

13\. Activities - Активности в рамках работы (например, \"Практические
(семинарские) занятия\", \"Зачет\", \"Индивидуальные занятия\")

14\. Work - Виды работ (например, \"Научная и научно-методическая
деятельность\", \"Учебно-методическая работа\")

15\. Files - Загруженные файлы

16\. Degrees - Ученые степени (например, \"Кандидат наук\", \"Доктор
наук\")

17\. Ranks - Ученые звания (например, \"Доцент\", \"Профессор\")

18\. ActivitiesEventsTypes - Связь между активностями и типами событий

19\. StateUser - Связь между пользователями и ставками

20\. EventsFiles - Связь между событиями и файлами

**4.2.2 Миграции и их применение**

Для создания новой миграции нужно:

1.  Внести изменения в модели данных в Domain проекте. Например,
    добавить новое поле в модель или создать новую сущность

2.  Перейти в Package Manager Console (Tools -\> NuGet Package Manager
    -\> Package Manager Console, Убедитесь, что выбран проект
    Tsu.IndividualPlan.Data в выпадающем списке Default Project)

3.  Выполнить команду:  
    Add-Migration ИмяМиграции -Context ApplicationDbContext

4.  Применить миграцию:  
    Update-Database

**4.2.3 Бэкапы и восстановление**

Создание бэкапа через pgAdmin

- Правый клик на базе данных

- Выберите \"Backup\...\"

- Формат: Custom или Plain

- Укажите путь сохранения

- Включите опцию \"Pre-data\", \"Data\" и \"Post-data\"

Создание бэкапа через командную строку  
pg_dump -U postgres -d tsu_db \> backup_YYYYMMDD.sql

**4.3 REST API (Tsu.IndividualPlan.WebApi)**

Проект Tsu.IndividualPlan.WebApi описывает REST API для предоставления
данных фронтенду через следующие основные контроллеры:

- **AuthController**: авторизация и регистрация пользователей

- **ReportController**: создание и экспорт индивидуальных планов

- **StateController**: управление ставками (создание, назначение, поиск)

- **LessonController**: работа с учебными дисциплинами

- **EventController**: управление событиями и активностями

- **UserController**: управление пользователями

- **RecordController**: работа с записями о выполненной работе

- **FileController**: загрузка и получение файлов

Каждый контроллер использует JWT-аутентификацию и включает
Swagger-документацию. API следует RESTful принципам, возвращая данные в
формате JSON. Для обработки ошибок используется глобальный exception
middleware, который форматирует все ошибки в единый формат ответа.

**4.4 Сервисы (Tsu.IndividualPlan.Transfer)**

Проект Tsu.IndividualPlan.Transfer служит промежуточным слоем между
доменной моделью и внешним API, обеспечивая преобразование сложных
доменных объектов в простые DTO (Data Transfer Objects) для передачи
данных на фронтенд. Проект содержит маппинги между доменными моделями и
DTO, что позволяет скрыть внутреннюю сложность бизнес-логики и
предоставить фронтенду только необходимые данные в удобном формате.
Здесь также находятся валидаторы входящих данных и специализированные
сервисы для обработки различных типов запросов, например, для работы с
файлами отчетов или обработки пользовательских данных. Важной
особенностью является то, что Transfer проект не имеет прямой
зависимости от слоя данных, работая только через интерфейсы доменного
слоя, что обеспечивает чистоту архитектуры.

**5 Frontend Архитектура**

Фронтенд представляет собой монолитное приложение на Angular с
использованием SCSS для стилизации. В папке @core содержатся основные
сервисы для работы с API, модели данных и guards для защиты маршрутов.
Здесь определены интерфейсы для всех сущностей системы: отчеты, ставки,
пользователи, события и другие.

В папке @ui находятся компоненты интерфейса, построенные с
использованием Angular Material. Это включает таблицы для отображения
данных, формы для ввода информации, модальные окна и навигационные
элементы. Каждый компонент имеет свой SCSS-файл для стилизации.

Основные функциональные модули приложения:

1.  Модуль авторизации обрабатывает вход пользователей и регистрацию,
    использует JWT-токены для аутентификации.

2.  Модуль отчетов позволяет:

- Загружать первую часть плана

- Добавлять и редактировать события

- Связывать события с дисциплинами

- Отслеживать выполнение работ

- Экспортировать итоговые отчеты

3.  Модуль управления ставками для администраторов включает:

- Создание новых ставок

- Назначение ставок преподавателям

- Отслеживание статусов и сроков

4.  Модуль событий обеспечивает:

- Добавление различных типов активностей

- Установку связей между событиями и дисциплинами

- Загрузку подтверждающих документов

Для управления состоянием используется RxJS, а для работы с формами -
реактивные формы Angular. Все взаимодействия с API происходят через
сервисы, которые инкапсулируют логику HTTP-запросов и обработку ошибок.
Маршрутизация настроена с учетом ролей пользователей, а lazy loading
модулей обеспечивает быструю начальную загрузку приложения.

В будущем планируется переход на Turborepo для управления
фронтенд-проектами, использование Tailwind CSS вместо SCSS и внедрение
микрофронтенд-архитектуры для улучшения масштабируемости и независимой
разработки модулей.

**6 DevOps**

Проект использует следующую инфраструктуру:

- nginx --- веб-сервер и обратный прокси

- client --- фронтенд-приложение на Angular

- backend --- монолитный бэкенд на C#

- postgresql --- база данных

- adminer --- веб-интерфейс для управления базой данных

Все сервисы запускаются через Docker Compose. Кроме того, каждый сервис
конфигурируется через .env (и аналоги). Именно эти файлы определяют
хосты и порты сервисов, с которыми имеется интеграция:

- api - настраивается через appsettings.json в директории с WebApi

- client - настраивается через environments.ts в директории
  app/environments

Сама же инфраструктура внутри себя взаимодействует следующим образом:

- Backend взаимодействует с PostgreSQL

- Adminer подключается к PostgreSQL для работы с базой данных.

- Nginx проксирует запросы от фронтенда к бэкенду и от внешних клиентов
  к фронтенду

- Client (Angular App) общается с Backend, но все запросы проходят через
  Nginx

В репозитории есть релизная ветка, к ней зацеплен github workflow,
который обращается по ssh к удалённому серверу, выполняет git pull и
пересобирает контейнеры:

```yaml
name: "Deployment CI"
on:
  push:
    branches: [ "master" ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - name: Run command on remote server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{secrets.SSH_HOST}}
          username: ${{secrets.SSH_USER}}
          key: ${{secrets.SSH_PRIVATE_KEY}}
          script: |
            cd ${{ secrets.PROJECT_FOLDER }};
            git checkout master;
            git pull;
            docker-compose --file docker-compose.yml --file docker-compose.override.yml down;
            docker-compose --file docker-compose.yml --file docker-compose.override.yml up -d;
```
